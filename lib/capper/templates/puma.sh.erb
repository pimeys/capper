#!/bin/bash
export HOME=<%= deploy_to %>
source <%= deploy_to %>/.rvm/scripts/rvm
export RAILS_ENV=<%= rails_env %>

PROCESS_NAME="$1" && shift
WORKERS="$1" && shift
MIN_THREADS="$1" && shift
MAX_THREADS="$1" && shift
SOCKET="tcp://0.0.0.0:$[9290]"

export PIDFILE=<%= pid_path %>/${PROCESS_NAME}.pid
export STDOUTLOG=<%= deploy_to %>/shared/log/${PROCESS_NAME}.stdout.log
export STDERRLOG=<%= deploy_to %>/shared/log/${PROCESS_NAME}.stderr.log

CMD="bundle exec puma -t $MIN_THREADS:$MAX_THREADS -e $RAILS_ENV --pidfile $PIDFILE -b $SOCKET -C <%= puma_config %> -w $WORKERS -d"

cd <%= current_path %> >/dev/null

sig () {
  test -s "$PIDFILE" && kill -$1 $(<$PIDFILE)
}

case $1 in
start)
  sig 0 && echo >&2 "Already running" && exit 0
  $CMD 1> $STDOUTLOG 2> $STDERRLOG
  ;;
stop)
  sig SIGTERM && exit 0
  echo >&2 "Not running"
  ;;
restart)
  sig SIGUSR1 && exit 0
  echo >&2 "Couldn't restart, starting with '$CMD' instead"
  $CMD &> $LOGFILE
  ;;
upgrade)
  sig SIGUSR1 && exit 0
  echo >&2 "Couldn't upgrade, starting with '$CMD' instead"
  $CMD &> $LOGFILE
  ;;
kill)
  sig SIGKILL && exit 0
  echo >&2 "Couldn't kill"
  ;;
*)
  echo >&2 "Usage: $0 <start|stop|restart|upgrade|kill>"
  exit 1
  ;;
esac

#!/bin/bash
export HOME=<%= deploy_to %>
source <%= deploy_to %>/.rvm/scripts/rvm
export RAILS_ENV=<%= rails_env %>

PROCESS_NAME="$1" && shift
MIN_THREADS="$1" && shift
MAX_THREADS="$1" && shift
PROCESS_NUM=`echo $PROCESS_NAME | cut -d'_' -f2`
SOCKET="tcp://0.0.0.0:$[PROCESS_NUM+9290]"

export PIDFILE=<%= pid_path %>/${PROCESS_NAME}.pid

<% if File.exist?(puma_config) %>
CMD="bundle exec puma -t $MIN_THREADS:$MAX_THREADS -e $RAILS_ENV --pidfile $PIDFILE -b $SOCKET -C <%= puma_config %>"
<% else %>
CMD="bundle exec puma -t $MIN_THREADS:$MAX_THREADS -e $RAILS_ENV --pidfile $PIDFILE -b $SOCKET"
<% end %>

cd <%= current_path %> >/dev/null

sig () {
  test -s "$PIDFILE" && kill -$1 $(<$PIDFILE)
}

case $1 in
start)
  sig 0 && echo >&2 "Already running" && exit 0
  exec $CMD
  ;;
stop)
  sig SIGTERM && exit 0
  echo >&2 "Not running"
  ;;
restart)
  sig SIGUSR2 && exit 0
  echo >&2 "Couldn't restart, starting with monit instead"
  ;;
upgrade)
  sig SIGUSR2 && exit 0
  echo >&2 "Couldn't upgrade, starting with monit instead"
  ;;
kill)
  sig SIGKILL && exit 0
  echo >&2 "Couldn't kill"
  ;;
*)
  echo >&2 "Usage: $0 <start|stop|restart|upgrade|kill>"
  exit 1
  ;;
esac
